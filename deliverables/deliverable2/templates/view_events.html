{% extends "base.html" %}

{% block title %}Community Events - Community Connect{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h4 class="card-title mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Community Events
                </h4>
                <small>Event management with DELETE operation capability</small>
            </div>
            
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-8">
                        <p class="text-muted mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Manage volunteer events organized by our partner organisations. 
                            Events can be deleted by clicking the delete button - this action cannot be undone.
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="badge bg-warning text-dark fs-6">
                            {{ events|length }} Event{{ 's' if events|length != 1 else '' }}
                        </span>
                    </div>
                </div>

                {% if events %}
                    <!-- Desktop/Tablet View -->
                    <div class="d-none d-lg-block">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">
                                            <i class="fas fa-hashtag me-1"></i>
                                            ID
                                        </th>
                                        <th scope="col">
                                            <i class="fas fa-calendar me-1"></i>
                                            Event Name
                                        </th>
                                        <th scope="col">
                                            <i class="fas fa-building me-1"></i>
                                            Organisation
                                        </th>
                                        <th scope="col">
                                            <i class="fas fa-clock me-1"></i>
                                            Date & Time
                                        </th>
                                        <th scope="col">
                                            <i class="fas fa-map-marker-alt me-1"></i>
                                            Location
                                        </th>
                                        <th scope="col">
                                            <i class="fas fa-users me-1"></i>
                                            Capacity
                                        </th>
                                        <th scope="col">
                                            <i class="fas fa-cogs me-1"></i>
                                            Actions
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for event in events %}
                                    <tr>
                                        <td>
                                            <span class="badge bg-secondary">{{ event.event_id }}</span>
                                        </td>
                                        <td>
                                            <strong class="text-primary">{{ event.event_name }}</strong>
                                            {% if event.description %}
                                                <br><small class="text-muted">{{ event.description[:50] }}{% if event.description|length > 50 %}...{% endif %}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="text-success">{{ event.org_name }}</span>
                                        </td>
                                        <td>
                                            <div class="text-nowrap">
                                                <strong>{{ event.start_date|datetime }}</strong>
                                                {% if event.end_date != event.start_date %}
                                                    <br><small class="text-muted">to {{ event.end_date|datetime }}</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <small>{{ event.location }}</small>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-info">{{ event.max_volunteers }}</span>
                                            <br><small class="text-muted">volunteers</small>
                                        </td>
                                        <td>
                                            <form method="POST" action="{{ url_for('delete_event_route', event_id=event.event_id) }}" class="d-inline">
                                                <button type="submit" 
                                                        class="btn btn-outline-danger btn-sm"
                                                        onclick="return confirmDelete('{{ event.event_name }}', 'event')">
                                                    <i class="fas fa-trash-alt me-1"></i>
                                                    Delete
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Mobile View -->
                    <div class="d-lg-none">
                        <div class="row">
                            {% for event in events %}
                            <div class="col-md-6 mb-4">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-header bg-light">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-0 text-primary">
                                                    <i class="fas fa-calendar me-1"></i>
                                                    {{ event.event_name }}
                                                </h6>
                                                <small class="text-success">{{ event.org_name }}</small>
                                            </div>
                                            <span class="badge bg-secondary">ID: {{ event.event_id }}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="card-body">
                                        <!-- Description -->
                                        {% if event.description %}
                                        <p class="card-text text-muted small mb-3">{{ event.description }}</p>
                                        {% endif %}
                                        
                                        <!-- Event Details -->
                                        <div class="mb-3">
                                            <!-- Start Date -->
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-calendar-day text-primary me-2" style="width: 16px;"></i>
                                                <small><strong>Start:</strong> {{ event.start_date|datetime }}</small>
                                            </div>
                                            
                                            <!-- End Date (if different) -->
                                            {% if event.end_date != event.start_date %}
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-calendar-check text-warning me-2" style="width: 16px;"></i>
                                                <small><strong>End:</strong> {{ event.end_date|datetime }}</small>
                                            </div>
                                            {% endif %}
                                            
                                            <!-- Location -->
                                            <div class="d-flex align-items-start mb-2">
                                                <i class="fas fa-map-marker-alt text-danger me-2 mt-1" style="width: 16px;"></i>
                                                <small>{{ event.location }}</small>
                                            </div>
                                            
                                            <!-- Capacity -->
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-users text-info me-2" style="width: 16px;"></i>
                                                <small><strong>Capacity:</strong> {{ event.max_volunteers }} volunteers</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card-footer bg-light border-0">
                                        <div class="d-grid">
                                            <form method="POST" action="{{ url_for('delete_event_route', event_id=event.event_id) }}">
                                                <button type="submit" 
                                                        class="btn btn-outline-danger btn-sm w-100"
                                                        onclick="return confirmDelete('{{ event.event_name }}', 'event')">
                                                    <i class="fas fa-trash-alt me-2"></i>
                                                    Delete Event
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Event Statistics -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card bg-light border-0">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-chart-bar me-2"></i>
                                        Event Statistics
                                    </h6>
                                    
                                    <div class="row text-center">
                                        <div class="col-6 col-md-3 mb-2">
                                            <div class="border-end">
                                                <div class="h4 mb-0 text-warning">{{ events|length }}</div>
                                                <small class="text-muted">Total Events</small>
                                            </div>
                                        </div>
                                        
                                        <div class="col-6 col-md-3 mb-2">
                                            <div class="border-end">
                                                {% set total_capacity = events|sum(attribute='max_volunteers') %}
                                                <div class="h4 mb-0 text-info">{{ total_capacity }}</div>
                                                <small class="text-muted">Total Capacity</small>
                                            </div>
                                        </div>
                                        
                                        <div class="col-6 col-md-3 mb-2">
                                            <div class="border-end">
                                                {% set upcoming_count = 0 %}
                                                {% for event in events %}
                                                    {% if event.start_date >= '2025-01-01' %}
                                                        {% set upcoming_count = upcoming_count + 1 %}
                                                    {% endif %}
                                                {% endfor %}
                                                <div class="h4 mb-0 text-success">{{ upcoming_count }}</div>
                                                <small class="text-muted">Upcoming</small>
                                            </div>
                                        </div>
                                        
                                        <div class="col-6 col-md-3 mb-2">
                                            {% if events %}
                                                {% set avg_capacity = (total_capacity / events|length)|round %}
                                                <div class="h4 mb-0 text-primary">{{ avg_capacity }}</div>
                                                <small class="text-muted">Avg Capacity</small>
                                            {% else %}
                                                <div class="h4 mb-0 text-muted">0</div>
                                                <small class="text-muted">Avg Capacity</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Delete Warning -->
                    <div class="alert alert-warning mt-4" role="alert">
                        <div class="d-flex">
                            <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                            <div>
                                <h6 class="alert-heading">⚠️ DELETE Operation Warning</h6>
                                <p class="mb-0">
                                    <strong>Deleting an event is permanent and cannot be undone.</strong> 
                                    When you delete an event, all associated volunteer registrations will also be removed 
                                    from the database due to CASCADE constraints. Please ensure you want to permanently 
                                    remove the event before confirming the deletion.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                {% else %}
                    <!-- No Events Found -->
                    <div class="text-center py-5">
                        <div class="display-1 text-muted mb-3">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <h4 class="text-muted">No Events Scheduled</h4>
                        <p class="text-muted">
                            There are currently no volunteer events scheduled in the system.
                        </p>
                        <div class="alert alert-info d-inline-block" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Database Note:</strong> This could indicate a database connection issue or that 
                            the database hasn't been populated with sample data yet.
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-bolt me-2"></i>
                    Quick Actions
                </h6>
                <div class="row">
                    <div class="col-md-6 col-lg-3 mb-2">
                        <div class="d-grid">
                            <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                                <i class="fas fa-home me-2"></i>
                                Back to Dashboard
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-2">
                        <div class="d-grid">
                            <a href="{{ url_for('view_volunteers') }}" class="btn btn-outline-info">
                                <i class="fas fa-users me-2"></i>
                                View Volunteers
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-2">
                        <div class="d-grid">
                            <a href="{{ url_for('view_organisations') }}" class="btn btn-outline-success">
                                <i class="fas fa-building me-2"></i>
                                View Organisations
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-2">
                        <div class="d-grid">
                            <a href="{{ url_for('new_volunteer') }}" class="btn btn-primary">
                                <i class="fas fa-user-plus me-2"></i>
                                Add New Volunteer
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Enhanced delete confirmation and event management
    document.addEventListener('DOMContentLoaded', function() {
        // Add enhanced hover effects to event cards and rows
        const hoverElements = document.querySelectorAll('.table tbody tr, .card.border-0.shadow-sm.h-100');
        hoverElements.forEach(element => {
            element.addEventListener('mouseenter', function() {
                if (this.tagName === 'TR') {
                    this.style.backgroundColor = '#fff3cd';
                } else {
                    this.style.transform = 'translateY(-2px)';
                    this.style.transition = 'transform 0.2s ease-in-out';
                }
            });
            
            element.addEventListener('mouseleave', function() {
                if (this.tagName === 'TR') {
                    this.style.backgroundColor = '';
                } else {
                    this.style.transform = 'translateY(0)';
                }
            });
        });
        
        // Add visual indicators for upcoming events
        const eventRows = document.querySelectorAll('tbody tr, .card');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        eventRows.forEach(element => {
            // Try to find date information in the element
            const dateText = element.textContent;
            const dateMatch = dateText.match(/(\d{1,2} \w+ \d{4})/);
            
            if (dateMatch) {
                const eventDate = new Date(dateMatch[0]);
                eventDate.setHours(0, 0, 0, 0);
                
                if (eventDate >= today) {
                    // Upcoming event - add indicator
                    if (element.tagName === 'TR') {
                        element.style.borderLeft = '4px solid #28a745';
                    } else {
                        element.style.borderLeft = '4px solid #28a745';
                    }
                    
                    // Add "upcoming" badge if it's within next 7 days
                    const daysDiff = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
                    if (daysDiff <= 7) {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-success ms-2';
                        badge.textContent = `${daysDiff} day${daysDiff !== 1 ? 's' : ''}`;
                        badge.title = 'Days until event';
                        
                        const nameElement = element.querySelector('.text-primary, strong');
                        if (nameElement) {
                            nameElement.appendChild(badge);
                        }
                    }
                } else {
                    // Past event - add different indicator
                    if (element.tagName === 'TR') {
                        element.style.borderLeft = '4px solid #6c757d';
                        element.style.opacity = '0.7';
                    } else {
                        element.style.borderLeft = '4px solid #6c757d';
                        element.style.opacity = '0.7';
                    }
                }
            }
        });
        
        // Add search functionality
        const cardBody = document.querySelector('.card-body');
        const firstRow = cardBody.querySelector('.row');
        
        // Create search input
        const searchDiv = document.createElement('div');
        searchDiv.className = 'col-12 mb-3';
        searchDiv.innerHTML = `
            <div class="input-group">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" class="form-control" id="eventSearch" 
                       placeholder="Search events by name, organisation, or location...">
                <button class="btn btn-outline-secondary" type="button" id="clearEventSearch">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        // Insert after the info row
        firstRow.after(searchDiv);
        
        const searchInput = document.getElementById('eventSearch');
        const clearButton = document.getElementById('clearEventSearch');
        const eventElements = document.querySelectorAll('tbody tr, .col-md-6');
        
        // Search functionality
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            
            eventElements.forEach(element => {
                const text = element.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    element.style.display = '';
                } else {
                    element.style.display = 'none';
                }
            });
        });
        
        // Clear search
        clearButton.addEventListener('click', function() {
            searchInput.value = '';
            eventElements.forEach(element => {
                element.style.display = '';
            });
            searchInput.focus();
        });
    });
    
    // Enhanced delete confirmation function (overrides the one in base.html)
    function confirmDelete(itemName, itemType = 'item') {
        const confirmed = confirm(
            `⚠️ PERMANENT DELETE WARNING ⚠️\n\n` +
            `Are you absolutely sure you want to delete the ${itemType}:\n"${itemName}"\n\n` +
            `This action will:\n` +
            `• Permanently remove the ${itemType} from the database\n` +
            `• Delete all associated volunteer registrations (CASCADE)\n` +
            `• Cannot be undone or recovered\n\n` +
            `Type the ${itemType} name to confirm, or click Cancel to abort.`
        );
        
        if (confirmed) {
            // Show loading state
            const deleteButtons = document.querySelectorAll('button[onclick*="confirmDelete"]');
            deleteButtons.forEach(btn => {
                if (btn.textContent.includes(itemName)) {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';
                    btn.disabled = true;
                }
            });
        }
        
        return confirmed;
    }
</script>
{% endblock %}